<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Tempo de Desloca√ß√£o + Espera - CUF</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px }
    #resultado { margin-top: 20px; font-size: 1.2em }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByfJeCpBqWdtJXhYgilMRN9SPdIqUzCEY"></script>
</head>
<body>

  <div>
    <label for="age">Idade:</label>
    <input type="number" id="age" min="0" placeholder="Ex: 35" autocomplete="off" />
  </div>
  <div id="resultado"></div>

  <script>
    let waitData = [];
   async function fetchWaitTimes() {
  const target = "https://www.cuf.pt/api/get-waiting-times?locale=pt";
  const res = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(target));
  const raw = await res.json();
  waitData = JSON.parse(raw.contents); // <- esta linha √© a corre√ß√£o!
}


    let minhaLat = null, minhaLng = null;

    async function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Navegador n√£o suporta geolocaliza√ß√£o.'));
        } else {
          navigator.geolocation.getCurrentPosition(pos => {
            minhaLat = pos.coords.latitude;
            minhaLng = pos.coords.longitude;
            resolve();
          }, err => reject(new Error('Verifique se permitiu o acesso √† localiza√ß√£o')));
        }
      });
    }

    async function calcularTempoSegundos(destination) {
      return new Promise(resolve => {
        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
          origins:      [{ lat: minhaLat, lng: minhaLng }],
          destinations: [ destination ],
          travelMode:   'DRIVING',
          drivingOptions: { departureTime: new Date(), trafficModel: google.maps.TrafficModel.BEST_GUESS }
        }, (response, status) => {
          if (status !== 'OK') return resolve(Infinity);
          const elem = response.rows[0].elements[0];
          resolve(elem.status === 'OK' && elem.duration_in_traffic
            ? elem.duration_in_traffic.value
            : Infinity);
        });
      });
    }

    async function minimoTempo(age) {
  const apCode = age >= 18
    ? 'Atendimento Permanente Adultos'
    : 'Atendimento Permanente Pedi√°trico';

  const candidates = [];

  for (const entry of waitData) {
    const ap = entry.aps.find(a => a.code === apCode);
    if (!ap) continue;

    const urg = ap.times.reduce((min, t) =>
      !min || (t.waitingTimeMinutes < min.waitingTimeMinutes)
        ? t
        : min,
      null
    );

    const waitMin = urg?.waitingTimeMinutes ?? Infinity;
    const travelSec = 0; // <- Ignorado para garantir que passa

    if (!isFinite(waitMin)) continue;

    candidates.push({
      hospital: entry.name,
      waitMin,
      travelMin: travelSec / 60,
      totalMin: waitMin
    });
  }

  if (candidates.length === 0) {
    document.getElementById('resultado').textContent = "‚ùå Nenhum hospital dispon√≠vel agora.";
    return;
  }

  candidates.sort((a, b) => a.totalMin - b.totalMin);
  const best = candidates[0];

  document.getElementById('resultado').innerHTML =
    `ü©∫ Hospital Sugerido: <strong>${best.hospital}</strong><br>` +
    `Tempo Espera: <strong>${best.waitMin} min</strong>`;
}


    window.addEventListener('load', () => {
      const ageInput = document.getElementById('age');
      ageInput.focus();
      ageInput.addEventListener('keydown', async e => {
        if (e.key === 'Enter') {
          const age = parseInt(ageInput.value, 10);
          if (isNaN(age)) {
            document.getElementById('resultado').textContent = '‚ö†Ô∏è Idade inv√°lida.';
            return;
          }
          document.getElementById('resultado').textContent = '‚åõ Processando...';
          try {
            await fetchWaitTimes();
            await getLocation();
            await minimoTempo(age);
          } catch (err) {
            document.getElementById('resultado').textContent = `‚ùå ${err.message}`;
          }
        }
      });
    });
  </script>
</body>
</html>
